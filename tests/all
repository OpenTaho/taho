#!/bin/bash

main() {
  go install .

  if [ -d tests ]; then
    cd tests || exit 1
  fi

  test 0 ccbd5579bcea24b33686b5f428a2102a3997a755
  test 1 9eda6f42550d672327451ba4caa23bc4da378a4a
  test 2 224899fbe5aad177d4cc40f31ed50e56e6d78dc7
}

test() {
  expected="$2"
  (
    rm -rf "result-$1"
    cp -r "$1" "result-$1"
    cd "result-$1" || exit 1

    result="$(
      (
        taho 2>&1;
        sha1sum ./*.tf
        sha1sum ./*.md
      ) |
      sha1sum |
      sed 's/ .*//'
    )"
    if [[ "$expected" != "$result" ]]; then
      >&2 echo "Test $1 failed; got $result"
      exit 1
    fi
  ) || exit 1

  rm -rf test
}

main